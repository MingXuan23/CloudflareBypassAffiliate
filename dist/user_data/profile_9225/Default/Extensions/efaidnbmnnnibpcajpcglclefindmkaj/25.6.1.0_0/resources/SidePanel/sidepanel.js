/*************************************************************************
* ADOBE CONFIDENTIAL
* ___________________
*
*  Copyright 2015 Adobe Systems Incorporated
*  All Rights Reserved.
*
* NOTICE:  All information contained herein is, and remains
* the property of Adobe Systems Incorporated and its suppliers,
* if any.  The intellectual and technical concepts contained
* herein are proprietary to Adobe Systems Incorporated and its
* suppliers and are protected by all applicable intellectual property laws,
* including trade secret and or copyright laws.
* Dissemination of this information or reproduction of this material
* is strictly forbidden unless prior written permission is obtained
* from Adobe Systems Incorporated.
**************************************************************************/
import{signInUtil as e}from"../../browser/js/viewer/signInUtils.js";import{dcLocalStorage as a}from"../../common/local-storage.js";import{upsellService as s}from"./upsellService.js";import{getContentLocale as t}from"./sidePanelUtil.js";import{util as i}from"../../browser/js/content-util.js";import{loggingApi as n}from"../../common/loggingApi.js";import{getGenAIServiceVariant as o}from"../../common/util.js";await a.init();const r=a.getItem("touchpoint");a.removeItem("touchpoint");const d=e=>{a.setItem("touchpoint",e),window.location.reload()},m=e=>{const a=new URLSearchParams(window.location.search),s=parseInt(a.get("tabId"));e&&chrome.runtime.sendMessage({main_op:"analytics",analytics:[e],tab:{id:s}})};window.onbeforeunload=()=>{chrome.tabs.sendMessage(l.tabId,{main_op:"removeHighlights"})},window.addEventListener("message",(async t=>{if(t.origin===l.origin)switch(t.data.main_op){case"preferences":chrome.runtime.openOptionsPage();break;case"highlightText":const i=await chrome.tabs.sendMessage(l.tabId,{...t.data});l.sendMessage({status:i,messageId:t.data.messageId});break;case"canHighlightText":const o=await chrome.tabs.sendMessage(l.tabId,{...t.data});l.sendMessage({status:o,messageId:t.data.messageId});break;case"sanitiseSources":const r=await chrome.tabs.sendMessage(l.tabId,{...t.data});l.sendMessage({status:r,messageId:t.data.messageId});break;case"removeHighlights":chrome.tabs.sendMessage(l.tabId,{...t.data});break;case"cdnReady":l.isCdnReadyResolver();break;case"reloadAll":chrome.runtime.sendMessage({main_op:"reload",touchpoint:t.data.touchpoint}),d(t.data.touchpoint);break;case"reload":d(t.data.touchpoint);break;case"analytics":m(t.data.event);break;case"log":n.info(t.data.message);break;case"signIn":e.sidePanelSignIn(l.tabId);break;case"subscribeNow":a.removeItem("upsellFromAnon"),s.clickSubscribeNow(),a.setItem("upsellFromAnon",t.data.isAnonUpsell);break;case"saveVisitorID":if(t.data.visitorID){const e=a.getItem("viewerVisitorID");a.setItem("viewerVisitorID",t.data.visitorID),e&&e!==t.data.visitorID&&m("DCBrowserExt:Analytics:viewerVisitorID:MCMID:Changed")}break;case"adminStatus":a.setItem("isAdminUser",t.data.isAdmin)}})),chrome.runtime.onMessage.addListener(((e,s,t)=>{if("reload"===e.main_op&&d(e.touchpoint),"reloadTab"===e.main_op&&e.tabId==l.tabId&&d(e.touchpoint),"post_upsell"===e.main_op&&e.tabId==l.tabId)return t({success:!0,message:"Upsell process completed successfully."}),l.sendMessage({type:"upsellComplete"}),a.removeItem("upsellFromAnon"),!0;"post_upsell_anon"===e.main_op&&e.tabId===l.tabId&&(a.removeItem("upsellFromAnon"),l.sendMessage({type:"upsellAnonTransition"})),"page_switched"===e.main_op&&e.tabId===l.tabId&&(e.isScrolled&&a.getItem("enableURLChangeOnScrollLogging")&&n.info({message:"URL changed due to page scroll",isSidePanelOpened:!0,url:e.url}),l.sendMessage({type:"sidepanelPageSwitch",disqualified:!e.qualified})),"chrome_viewer_opened"===e.main_op&&e.activeTabId==l.tabId&&window.close()}));const l=new class{urlParams=new URLSearchParams(window.location.search);tabId=parseInt(this.urlParams.get("tabId"));iframeElement=document.getElementById("sidepanel");constructor(){n.info({message:"Sidepanel.js file initialized"});const e=new URL(a.getItem("sidepanelUrl")),s="false"!==a.getItem("logAnalytics"),t="false"!==a.getItem("ANALYTICS_OPT_IN_ADMIN"),i=a.getItem("appLocale")||chrome.i18n.getMessage("@@ui_locale"),r=a.getItem("sidePanelUUID");e.searchParams.append("la",s&&t),e.searchParams.append("ca",chrome.runtime.id),e.searchParams.append("cluster",o()),e.searchParams.append("locale",i),e.searchParams.append("uuid",r),this.iframeElement.src=e.href,this.iframeElement.onload=()=>n.info({message:"Sidepanel iframe loaded"}),this.iframeElement.onerror=e=>n.error({message:"Error in loading sidepanel iframe",err:e}),this.origin=e.origin,this.port=chrome.runtime.connect({name:`sidepanel_${this.tabId}`}),setInterval((()=>{this.port.postMessage({action:"keep_alive"})}),2e4)}isCdnReady=new Promise(((e,a)=>{const s=setTimeout((()=>{n.info({message:"Sidepanel CDN timed out"}),a(new Error("Hosted sidepanel loading timeout........."))}),1e4);this.isCdnReadyResolver=()=>{clearTimeout(s),e()}}));supportedOrigin=e=>{try{return!![/^https:\/\/([a-zA-Z\d-]+\.){0,}(adobe|acrobat)\.com(:[0-9]*)?$/].find((a=>a.test(e)))}catch(e){return!1}};sendMessage=e=>{this.iframeElement&&this.supportedOrigin(this.origin)&&this.isCdnReady.then((()=>this.iframeElement.contentWindow.postMessage(e,this.origin)))}},c=await chrome.tabs.sendMessage(l.tabId,{main_op:"getHtmlContent"});i.consoleLog("HTML: Response from content script: ",c);let p=c?.htmlContent;const g=await t(c.textContent);l.sendMessage({type:"sidepanelHtmlContent",htmlContent:p,initialQuestion:c.initialQuestion,disqualified:c.disqualified,pageLanguage:g.language,touchpoint:r});