/*************************************************************************
* ADOBE CONFIDENTIAL
* ___________________
*
*  Copyright 2015 Adobe Systems Incorporated
*  All Rights Reserved.
*
* NOTICE:  All information contained herein is, and remains
* the property of Adobe Systems Incorporated and its suppliers,
* if any.  The intellectual and technical concepts contained
* herein are proprietary to Adobe Systems Incorporated and its
* suppliers and are protected by all applicable intellectual property laws,
* including trade secret and or copyright laws.
* Dissemination of this information or reproduction of this material
* is strictly forbidden unless prior written permission is obtained
* from Adobe Systems Incorporated.
**************************************************************************/
import{dcLocalStorage as e}from"./common/local-storage.js";import{hydrateWithStorage as o}from"./sw_modules/hydrate.js";import{communicate as s}from"./sw_modules/communicate.js";import{onMessageListener as t}from"./sw_modules/common.js";import{externalClients as r}from"./sw_modules/externalClients.js";import{feat as n}from"./sw_modules/feat.js";import{session as a}from"./sw_modules/session.js";import{acroweb2pdf as d}from"./sw_modules/acro-web2pdf.js";import{userSubscriptionAlarmHandler as m}from"./sw_modules/user-subscription.js";import{startQAWithWebpage as i}from"./sw_modules/ch-context-menu.js";import"./sw_modules/acro-gstate.js";import{startup as c,registerActions as p,onWelcomeTabRemoved as l,contextMenuOnClickHandler as h,updateAnalyticsOptInAdmin as u,refocusLocalFteWindow as f,onLocalFileClosed as w,onLocalFteWindowClosed as b,onDownloadChanged as _}from"./sw_modules/ch-context-menu.js";import{processRequest as g,honorRequest as L,onTabsUpdated as y,onTabActivated as x,logWebpageDomain as I,handlePrefetchValidation as j,detectAndStorePrefetch as v,cleanupPrefetchForTab as R}from"./sw_modules/viewer-module.js";import{indexedDBScript as C}from"./common/indexDB.js";import{offscreenActions as T}from"./sw_modules/offscreen-actions.js";import{analytics as A}from"./common/analytics.js";import{expressModalTabCloseListener as S}from"./sw_modules/express.js";import{sidepanelState as M}from"./sw_modules/SidepanelState.js";const P=["http","https","ftp","file","blob","data","filesystem","drive"];try{const T=chrome.runtime.getURL("/");chrome.runtime.onConnect.addListener((e=>{const[o,s]=e.name.split("_");"sidepanel"===o&&(e.onMessage.addListener((()=>{})),chrome.tabs.sendMessage(parseInt(s),{action:"sidepanel_opened"}),M.setIsOpen(parseInt(s),!0),e.onDisconnect.addListener((()=>{chrome.tabs.sendMessage(parseInt(s),{action:"sidepanel_closed"}),M.setIsOpen(parseInt(s),!1)})))})),chrome.management.getSelf(o(c)),chrome.runtime.onInstalled.addListener(o(p)),chrome.contextMenus.onClicked.addListener(o(h)),chrome.runtime.onStartup.addListener(o((()=>e.removeItem("loadedTabsInfo")))),chrome.runtime.onMessageExternal.addListener(o(n,r)),chrome.action.onUserSettingsChanged?.addListener(o((async o=>{const s=e.getItem("pinToolbarSettingsWindowId");if(s&&o.isOnToolbar)try{await chrome.windows.remove(s)}catch(e){}}))),chrome.webRequest.onHeadersReceived.addListener((e=>{o((e=>{j(e)||(g(e,!1),I(e))}))(e)}),{urls:["http://*/*","https://*/*"],types:["main_frame","sub_frame"]},["responseHeaders"]),chrome.webRequest.onBeforeRequest.addListener((e=>{o(g)(e,!0)}),{urls:["file://*/*.pdf","file://*/*.PDF"],types:["main_frame","sub_frame"]}),chrome.webRequest.onBeforeSendHeaders.addListener((e=>{o(v)(e)}),{urls:["http://*/*","https://*/*"],types:["main_frame"]},["requestHeaders"]),chrome.webRequest.onBeforeRequest.addListener(o(L),{urls:P.map((e=>T+e+"*")),types:["main_frame"]}),chrome.webNavigation.onBeforeNavigate.addListener(o(s.handlerTabs),{frameType:"outermost_frame"}),chrome.runtime.onMessage.addListener(((...e)=>{const[r,n,a]=e;switch(r?.type){case"getWindowType":n?.tab?.windowId?chrome.windows.get(n.tab.windowId).then((e=>{const o="popup"===e.type,s="app"===e.type;a({isPopup:o,isApp:s})})):a({isPopup:!1,isApp:!1});break;case"open_side_panel":i(r,n.tab||r.tab);break;case"open_options_page":chrome.runtime.openOptionsPage();break;case"send_to_sidepanel":chrome.runtime.sendMessage({...r,tabId:n.tab?.id});break;case"get_sidepanel_state":a({isOpen:M.getIsOpen(n.tab?.id)})}return o(t,s.proxy(s.handler))(...e),!0})),chrome.tabs.onRemoved.addListener(o(s.proxy(s.close),a.proxy(a.onSessionTabRemoved),l,((...o)=>{e.getItem("LocalFileAccessTouchpointsFromViewer")||C.deleteDataFromIndexedDB(...o)}),w,s.proxy(s.getCurrentTabInfoAndUpdateLoadedTabs),S,(e=>M.clear(e)),R)),chrome.tabs.onUpdated.addListener(o(y)),chrome.storage.managed.onChanged.addListener(o(u)),chrome.extension.isAllowedFileSchemeAccess(o(s.proxy(s.setIsAllowedLocalFileAccess))),chrome.tabs.onActivated.addListener((async(...e)=>{o(x,s.proxy(s.active),f)(...e)})),chrome.tabs.onReplaced.addListener(o(s.proxy(s.tabReplace))),chrome.tabs.onMoved.addListener(o(s.proxy(s.getCurrentTabInfoAndUpdateLoadedTabs))),d.setNcPort(chrome.runtime.connectNative("com.adobe.acrobat.chrome_webcapture")),d.ncPort.onMessage.addListener(d.proxy(d.nativeMessageCallback)),d.ncPort.onDisconnect.addListener(d.proxy(d.nativeOnDisconnect)),chrome.alarms.onAlarm.addListener(o(m)),chrome.windows.onRemoved.addListener(o(b)),chrome.downloads.onChanged.addListener(o(_)),chrome.downloads.onCreated.addListener((e=>{e?.finalUrl&&new URL(e?.finalUrl)?.searchParams?.has("acrobatPromotionSource")&&(chrome.downloads.cancel(e?.id),A.event("DCBrowserExt:PromotionSource:Download:Cancel"))}))}catch(e){console.log(e)}